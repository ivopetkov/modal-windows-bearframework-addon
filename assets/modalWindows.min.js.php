<?php

/*
 * Modal windows addon for Bear Framework
 * https://github.com/ivopetkov/modal-windows-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.modalWindows=ivoPetkov.bearFrameworkAddons.modalWindows||function(){var n=!1,e={},t=null,o="",i="",l="";Promise=window.Promise||function(n){var e=[],t=null;this.then=function(n){return e.push(n),this},this.catch=function(n){return null===t&&(t=n),this};var o=function(){for(var n in e)e[n].apply(null,arguments)},i=function(){null!==t&&t.apply(null,arguments)};window.setTimeout((function(){n(o,i)}),16)};var r=null,d=null,u=0,c=function(n,e){e?(n.setAttribute("class","ipmdlwndwv"),n.removeAttribute("inert")):(n.setAttribute("class","ipmdlwndwvh"),n.setAttribute("inert","true"))},a=function(){if(null!==t&&t.lastChild){var n=t.lastChild;if(1===d)return h++,v(n.mwCloseOnEscKey).then((function(){c(n,!0)})),!1;if(null!==n.getAttribute("data-mw-disabled"))return!1;if(n.mwClose())return!1}else null!==d&&y()},s=function(n){return u++,new Promise((function(e,t){1!==d?(d=1,clientPackages.get("lightbox",{timeout:15}).then((function(t){r=t.make({showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:a}),e()}))):e()}))},v=function(n){return--u<0&&(u=0),u>0?new Promise((function(n,e){n()})):1===d?(d=2,r.open("",{showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:a,resolveBeforeHTMLAdded:!0})):new Promise((function(n,e){n()}))},m=function(){null!==r&&(u=0,d=null,r.close(),r=null)},f=n=>{let e=document.createElement("div");return e.innerText=n,e.innerHTML},h=0,w=function(){var i=null,l=function(n){void 0===n&&(n={});var e=void 0!==n.returnPromise&&n.returnPromise,o=void 0!==n.expectOpen&&n.expectOpen,l=void 0!==n.expectShowLoading&&n.expectShowLoading;if(h++,null!==i&&null!==t){var r=null,d=i.previousSibling;return i.setAttribute("class","ipmdlwndwh"),window.setTimeout((function(){t.removeChild(i),i=null,0===t.childNodes.length&&(t.parentNode.removeChild(t),t=null),null!==d&&c(d,!0),(o||l)&&(null!==t&&0!==t.childNodes.length||m()),null!==r&&r(!0)}),300),o||l||t.childNodes.length-1==0&&m(),!e||new Promise((function(n,e){r=n}))}return!!e&&new Promise((function(n,e){n(!1)}))},r=function(){null!==i&&(i.removeAttribute("data-mw-disabled"),i.removeAttribute("inert"))},u=function(){null!==i&&(i.setAttribute("data-mw-disabled","1"),i.setAttribute("inert","true"))};return{open:function(a,m,w,p){if(void 0===m&&(m={}),void 0===w&&(w={}),null!==i)return!1;var y=++h,C=void 0!==w.onOpen?w.onOpen:null,P=void 0!==w.onFail?w.onFail:null,E=void 0===w.closeOnEscKey||w.closeOnEscKey,A=void 0!==w.showErrors&&w.showErrors,k=void 0!==w.timeout?w.timeout:30;if(null!==t)for(var L=t.childNodes,T=0;T<L.length;T++)c(L[T],!1);var S=function(){if(O().then((function(){if(A){var n=window.navigator;void 0!==n.onLine&&n.onLine?b():g()}if(null!==P)try{P()}catch(n){}})),null!==t){var n=t.lastChild;null!==n&&c(n,!0)}},K=function(e,t,o){n?e():clientPackages.get("html5DOMDocument",{timeout:15}).then((function(i){if(null===o){var l=document.head.querySelector('[type="ipmwg"]');null!==l&&(o=l.getAttribute("data-content"))}null!==o?(i.insert(o),n=!0,e()):t()})).catch(S)},N=a+"$"+p+"$"+JSON.stringify(m),D=function(n,d){null===t&&((t=document.createElement("div")).setAttribute("class","ipmdlwndwsc"),document.body.appendChild(t)),(i=document.createElement("div")).setAttribute("data-form-tooltip-container","true"),t.appendChild(i);var a="";a+='<div data-modal-window-component="header">',a+='<div data-modal-window-component="header-title"></div>',a+='<div data-modal-window-component="header-buttons">',void 0!==n.headerButtons&&(a+=n.headerButtons.join("")),a+='<div data-modal-window-component="header-button-close" tabindex="0" role="button" title="'+o+'"></div>',a+="</div>",a+="</div>",a+='<div data-modal-window-component="content"></div>',html5DOMDocument.insert('<div><div data-modal-window-component="window">'+a+"</div></div>",[i]);var s=i.firstChild.firstChild,v=s.querySelector('[data-modal-window-component="header-title"]'),m=s.querySelector('[data-modal-window-component="header-button-close"]'),h=s.querySelector('[data-modal-window-component="content"]');m.addEventListener("click",l),m.addEventListener("keydown",(function(n){13===n.keyCode&&l()})),void 0!==n.width&&(s.style.width=n.width),void 0!==n.title&&(v.innerHTML=f(n.title).split("\n").join("<br>")),void 0!==n.content&&html5DOMDocument.insert(n.content,[h]);for(var w=s.querySelectorAll("form"),p=0;p<w.length;p++){var b=w[p];b.addEventListener("submitstart",u),b.addEventListener("submitend",r)}window.setTimeout((function(){c(i,!0)}),16),null!==C&&C(i),i.mwClose=l,i.mwCloseOnEscKey=E,d&&void 0!==n.cacheTTL&&(e[N]=[n,(new Date).getTime()+1e3*n.cacheTTL])},q=null;if("m"===p){var x='<div data-modal-window-component="content-message">'+f(m.m).split("\n").join("<br>")+'</div><div data-modal-window-component="content-button-ok">OK</div>';q={width:"400px",content:x}}var B=function(){s(E).then((function(){if(void 0!==e[N]&&e[N][1]>(new Date).getTime())K((function(){v(E).then((function(){h===y&&2===d&&D(e[N][0],!1)}))}),S,null);else{var t=function(){clientPackages.get("serverRequests",{timeout:15}).then((function(e){e.send("-modal-window-open",{i:a,d:JSON.stringify(null!==q?{}:m),g:n?0:1},{timeout:k}).then((function(n){v(E).then((function(){if(h===y&&2===d){var e=JSON.parse(n),t=function(){null!==q?D(q,!1):void 0!==e.c?D(e.c,!0):S()};void 0!==e.g?K(t,S,e.g):t()}}))})).catch(S)})).catch(S)};K(t,t,null)}}))};if(null!==q)s(E).then((function(){K((function(){v(E).then((function(){D(q,!1)}))}),(function(){v(E).then((function(){B()}))}),null)}));else{if("d"===p&&void 0===e[N]&&"{}"===JSON.stringify(m)){var F=document.head.querySelector('[type="ipmw"][data-name="'+a+'"]');if(null!==F){var M=JSON.parse(F.getAttribute("data-content"));e[N]=[M,(new Date).getTime()+1e3*M.cacheTTL]}}B()}return!0},close:l,enable:r,disable:u}},p=function(n){var e={onOpen:function(n){n.querySelector('[data-modal-window-component="content-button-ok"]').addEventListener("click",C)}},t=!1;e.onFail=function(){t=!0,alert(n)},e.closeOnEscKey=!0;var o=w();return o.open("",{m:n},e,"m"),{close:function(n){return!t&&o.close(n)}}},b=function(n){return void 0===n&&(n=i),p(n)},g=function(n){return void 0===n&&(n=l),p(n)},y=function(n){return void 0===n&&(n={}),new Promise((function(e,o){if(null!==t&&t.childNodes.length>0){for(var i=t.childNodes,l=i.length-2;l>=0;l--)t.removeChild(i[l]);var r=t.firstChild;null!==r?(n.returnPromise=!0,r.mwClose(n).then(e)):e()}else h++,O().then(e).catch(o)}))},C=function(n){return void 0===n&&(n={}),new Promise((function(e,o){if(null!==t){var i=t.lastChild;if(null!==i)return n.returnPromise=!0,void i.mwClose(n).then(e)}e()}))},O=function(){return new Promise((function(n,e){var o=!0;null!==t&&t.lastChild&&(o=t.lastChild.mwCloseOnEscKey);v(o).then((function(){null!==t&&0!==t.childNodes.length||m(),n()})).catch(e)}))};return{initialize:function(n){return o=n[0],i=n[1],l=n[2],this},open:function(n,e,t){void 0===t&&(t={});var o=w();return o.open(n,e,t,"d"),{close:function(n){return o.close(n)},enable:function(){o.enable()},disable:function(){o.disable()}}},openMessage:p,openError:b,openOffline:g,closeAll:y,closeCurrent:C,showLoading:function(n){void 0===n&&(n={});var e=void 0===n.closeOnEscKey||n.closeOnEscKey;return new Promise((function(n,t){s(e).then(n).catch(t)}))},hideLoading:O,hasOpened:function(){return null!==r}}}();
EOT;
