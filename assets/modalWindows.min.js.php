<?php

/*
 * Modal windows addon for Bear Framework
 * https://github.com/ivopetkov/modal-windows-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.modalWindows=ivoPetkov.bearFrameworkAddons.modalWindows||function(){var n=!1,e={},t=null,o="";Promise=window.Promise||function(n){var e=[],t=null;this.then=function(n){return e.push(n),this},this.catch=function(n){return null===t&&(t=n),this};var o=function(){for(var n in e)e[n].apply(null,arguments)},i=function(){null!==t&&t.apply(null,arguments)};window.setTimeout((function(){n(o,i)}),16)};var i=null,l=null,d=0,r=function(n,e){e?(n.setAttribute("class","ipmdlwndwv"),n.removeAttribute("inert")):(n.setAttribute("class","ipmdlwndwvh"),n.setAttribute("inert","true"))},c=function(){if(null!==t&&t.lastChild){var n=t.lastChild;if(1===l)return m++,a(n.mwCloseOnEscKey).then((function(){r(n,!0)})),!1;if(null!==n.getAttribute("data-mw-disabled"))return!1;if(n.mwClose())return!1}else null!==l&&w()},u=function(n){return d++,new Promise((function(e,t){1!==l?(l=1,clientPackages.get("lightbox").then((function(t){i=t.make({showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:c}),e()}))):e()}))},a=function(n){return--d<0&&(d=0),d>0?new Promise((function(n,e){n()})):1===l?(l=2,i.open("",{showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:c,resolveBeforeHTMLAdded:!0})):new Promise((function(n,e){n()}))},s=function(){null!==i&&(d=0,l=null,i.close(),i=null)},v=n=>{let e=document.createElement("div");return e.innerText=n,e.innerHTML},m=0,h=function(){var i=null,d=function(){if(m++,null!==i){var n=i.previousSibling;return i.setAttribute("class","ipmdlwndwh"),window.setTimeout((function(){t.removeChild(i),0===t.childNodes.length&&(t.parentNode.removeChild(t),t=null),null!==n&&r(n,!0)}),300),0===t.childNodes.length-1&&s(),!0}return!1},c=function(){null!==i&&(i.removeAttribute("data-mw-disabled"),i.removeAttribute("inert"))},h=function(){null!==i&&(i.setAttribute("data-mw-disabled","1"),i.setAttribute("inert","true"))};return{open:function(s,w,f,b){void 0===w&&(w={}),void 0===f&&(f={});var g=++m,C=void 0!==f.onOpen?f.onOpen:null,y=void 0===f.closeOnEscKey||f.closeOnEscKey;if(null!==t)for(var O=t.childNodes,k=0;k<O.length;k++)r(O[k],!1);var E=function(){if(p(),null!==t){var n=t.lastChild;null!==n&&r(n,!0)}},A=s+"$"+b+"$"+JSON.stringify(w),P=function(n,l){null===t&&((t=document.createElement("div")).setAttribute("class","ipmdlwndwsc"),document.body.appendChild(t)),(i=document.createElement("div")).setAttribute("data-form-tooltip-container","true"),t.appendChild(i);var u="";u+='<div data-modal-window-component="header">',u+='<div data-modal-window-component="header-title"></div>',u+='<div data-modal-window-component="header-buttons">',void 0!==n.headerButtons&&(u+=n.headerButtons.join("")),u+='<div data-modal-window-component="header-button-close" tabindex="0" role="button" title="'+o+'"></div>',u+="</div>",u+="</div>",u+='<div data-modal-window-component="content"></div>',html5DOMDocument.insert('<div><div data-modal-window-component="window">'+u+"</div></div>",[i]);var a=i.firstChild.firstChild,s=a.querySelector('[data-modal-window-component="header-title"]'),m=a.querySelector('[data-modal-window-component="header-button-close"]'),w=a.querySelector('[data-modal-window-component="content"]');m.addEventListener("click",d),m.addEventListener("keydown",(function(n){13===n.keyCode&&d()})),void 0!==n.width&&(a.style.width=n.width),void 0!==n.title&&(s.innerHTML=v(n.title).split("\n").join("<br>")),void 0!==n.content&&html5DOMDocument.insert(n.content,[w]);for(var f=a.querySelectorAll("form"),p=0;p<f.length;p++){var b=f[p];b.addEventListener("submitstart",h),b.addEventListener("submitend",c)}window.setTimeout((function(){r(i,!0)}),16),null!==C&&C(i),i.mwClose=d,i.mwCloseOnEscKey=y,l&&void 0!==n.cacheTTL&&(e[A]=[n,(new Date).getTime()+1e3*n.cacheTTL])},K=null;if("m"===b){var T='<div data-modal-window-component="content-message">'+v(w.m).split("\n").join("<br>")+'</div><div data-modal-window-component="content-button-ok">OK</div>';K={width:"400px",content:T}}null!==K&&n?u(y).then((function(){a(y).then((function(){P(K,!1)}))})):u(y).then((function(){void 0!==e[A]&&e[A][1]>(new Date).getTime()?a(y).then((function(){m===g&&2===l&&P(e[A][0],!1)})):clientPackages.get("serverRequests").then((function(e){clientPackages.get("html5DOMDocument").then((function(t){e.send("-modal-window-open",{i:s,d:JSON.stringify(null!==K?{}:w),g:n?0:1}).then((function(e){a(y).then((function(){if(m===g&&2===l){var o=JSON.parse(e);void 0!==o.s&&(t.insert(o.s),n=!0),null!==K?P(K,!1):void 0!==o.c?P(o.c,!0):E()}}))})).catch(E)})).catch(E)})).catch(E)}))},close:d,enable:c,disable:h}},w=function(){return new Promise((function(n,e){if(null!==t&&t.childNodes.length>0){for(var o=t.childNodes,i=o.length-2;i>=0;i--)t.removeChild(o[i]);var l=t.firstChild;null!==l&&l.mwClose(),n()}else m++,p().then(n).catch(e)}))},f=function(){if(null!==t){var n=t.lastChild;null!==n&&n.mwClose()}},p=function(){return new Promise((function(n,e){var o=!0;null!==t&&t.lastChild&&(o=t.lastChild.mwCloseOnEscKey);a(o).then((function(){null!==t&&0!==t.childNodes.length||s(),n()})).catch(e)}))};return{initialize:function(n){return o=n[0],this},open:function(n,e,t){void 0===t&&(t={});var o=h();return o.open(n,e,t,"d"),o},openMessage:function(n){var e={onOpen:function(n){n.querySelector('[data-modal-window-component="content-button-ok"]').addEventListener("click",f)},closeOnEscKey:!0},t=h();return t.open("",{m:n},e,"m"),t},closeAll:w,closeCurrent:f,showLoading:function(n){void 0===n&&(n={});var e=void 0===n.closeOnEscKey||n.closeOnEscKey;return new Promise((function(n,t){u(e).then(n).catch(t)}))},hideLoading:p,hasOpened:function(){return null!==i}}}();
EOT;
