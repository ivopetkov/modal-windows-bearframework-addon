<?php

/*
 * Modal windows addon for Bear Framework
 * https://github.com/ivopetkov/modal-windows-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.modalWindows=ivoPetkov.bearFrameworkAddons.modalWindows||function(){var n=!1,e={},t=null,o="",i="",l="",r=0,u="mw-"+(new Date).getTime().toString()+"-";Promise=window.Promise||function(n){var e=[],t=null;this.then=function(n){return e.push(n),this},this.catch=function(n){return null===t&&(t=n),this};var o=function(){for(var n in e)e[n].apply(null,arguments)},i=function(){null!==t&&t.apply(null,arguments)};window.setTimeout((function(){n(o,i)}),16)};var d=null,c=!1,a=!1,s=function(){if(c)return!1;if(a)return!1;var n=d.getData("ipmw");null!==n?"l"===n||(null!==document.getElementById(n)?L({lastWindowID:n}):-1===n.indexOf(u)&&L()):L()},v=function(n){d.open(null,null,null,{ipmw:n},!1)},f=null,m=null,w=0,h=function(n,e){e?(n.setAttribute("class","ipmdlwndwv"),n.removeAttribute("inert")):(n.setAttribute("class","ipmdlwndwvh"),n.setAttribute("inert","true"))},p=function(){if(null!==t&&t.lastChild){var n=t.lastChild;if(1===m)return P++,b(n.mwCloseOnEscKey).then((function(){h(n,!0)})),!1;if(null!==n.getAttribute("data-mw-disabled"))return!1;if(n.mwClose())return!1}else null!==m&&L()},g=function(n){return w++,new Promise((function(e,t){if(1!==m){m=1;var o=function(){clientPackages.get("lightbox",{timeout:15}).then((function(t){f=t.make({showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:p}),v("l"),e()}))};null===d?clientPackages.get("windowNavigation").then((function(n){(d=n).addChangeHandler(s),o()})):o()}else e()}))},b=function(n){return--w<0&&(w=0),w>0?new Promise((function(n,e){n()})):1===m?(m=2,new Promise((function(e,t){("l"!==d.getData("ipmw")?Promise.resolve():(c=!0,new Promise((function(n,e){d.goBack().then((function(){c=!1,n()}))})))).then((function(){f.open("",{showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:p,resolveBeforeHTMLAdded:!0}).then(e).catch(t)}))}))):new Promise((function(n,e){n()}))},y=function(){null!==f&&(w=0,m=null,f.close(),f=null)},C=n=>{let e=document.createElement("div");return e.innerText=n,e.innerHTML},P=0,O=function(){var i=null,l=function(n){void 0===n&&(n={});var e=void 0!==n.returnPromise&&n.returnPromise,o=void 0!==n.expectOpen&&n.expectOpen,l=void 0!==n.expectShowLoading&&n.expectShowLoading;if(P++,null!==i&&null!==t){var r="ipmdlwndwv"===i.getAttribute("class"),u=null,c=i.previousSibling;return i.setAttribute("class","ipmdlwndwh"),r&&function(n){n.id===d.getData("ipmw")&&(a=!0,d.goBack().then((function(){a=!1})))}(i),window.setTimeout((function(){t.removeChild(i),i=null,0===t.childNodes.length&&(t.parentNode.removeChild(t),t=null),null!==c&&h(c,!0),(o||l)&&(null!==t&&0!==t.childNodes.length||y()),null!==u&&u(!0)}),300),o||l||t.childNodes.length-1==0&&y(),!e||new Promise((function(n,e){u=n}))}return!!e&&new Promise((function(n,e){n(!1)}))},c=function(){null!==i&&(i.removeAttribute("data-mw-disabled"),i.removeAttribute("inert"))},s=function(){null!==i&&(i.setAttribute("data-mw-disabled","1"),i.setAttribute("inert","true"))};return{open:function(d,a,f,w){if(void 0===a&&(a={}),void 0===f&&(f={}),null!==i)return!1;var p=++P,y=void 0!==f.onOpen?f.onOpen:null,O=void 0!==f.onFail?f.onFail:null,A=void 0===f.closeOnEscKey||f.closeOnEscKey,L=void 0!==f.showErrors&&f.showErrors,T=void 0!==f.timeout?f.timeout:30;if(null!==t)for(var S=t.childNodes,N=0;N<S.length;N++)h(S[N],!1);var K=function(){if(D().then((function(){if(L){var n=window.navigator;void 0!==n.onLine&&n.onLine?E():k()}if(null!==O)try{O()}catch(n){}})),null!==t){var n=t.lastChild;null!==n&&h(n,!0)}},B=function(e,t,o){n?e():clientPackages.get("html5DOMDocument",{timeout:15}).then((function(i){if(null===o){var l=document.head.querySelector('[type="ipmwg"]');null!==l&&(o=l.getAttribute("data-content"))}null!==o?(i.insert(o),n=!0,e()):t()})).catch(K)},x=d+"$"+w+"$"+JSON.stringify(a),q=function(n,d){null===t&&((t=document.createElement("div")).setAttribute("class","ipmdlwndwsc"),document.body.appendChild(t)),(i=document.createElement("div")).setAttribute("id",(r++,u+r)),i.setAttribute("data-form-tooltip-container","true"),t.appendChild(i);var a="";a+='<div data-modal-window-component="header">',a+='<div data-modal-window-component="header-title"></div>',a+='<div data-modal-window-component="header-buttons">',void 0!==n.headerButtons&&(a+=n.headerButtons.join("")),a+='<div data-modal-window-component="header-button-close" tabindex="0" role="button" title="'+o+'"></div>',a+="</div>",a+="</div>",a+='<div data-modal-window-component="content"></div>',html5DOMDocument.insert('<div><div data-modal-window-component="window">'+a+"</div></div>",[i]);var f=i.firstChild.firstChild,m=f.querySelector('[data-modal-window-component="header-title"]'),w=f.querySelector('[data-modal-window-component="header-button-close"]'),p=f.querySelector('[data-modal-window-component="content"]');w.addEventListener("click",l),w.addEventListener("keydown",(function(n){13===n.keyCode&&l()})),void 0!==n.width&&(f.style.width=n.width),void 0!==n.title&&(m.innerHTML=C(n.title).split("\n").join("<br>")),void 0!==n.content&&html5DOMDocument.insert(n.content,[p]);for(var g=f.querySelectorAll("form"),b=0;b<g.length;b++){var P=g[b];P.addEventListener("submitstart",s),P.addEventListener("submitend",c)}window.setTimeout((function(){h(i,!0)}),16),null!==y&&y(i),i.mwClose=l,i.mwCloseOnEscKey=A,d&&void 0!==n.cacheTTL&&(e[x]=[n,(new Date).getTime()+1e3*n.cacheTTL]),function(n){v(n.id)}(i)},F=null;if("m"===w){var M='<div data-modal-window-component="content-message">'+C(a.m).split("\n").join("<br>")+'</div><div data-modal-window-component="content-button-ok">OK</div>';F={width:"400px",content:M}}var J=function(){g(A).then((function(){if(void 0!==e[x]&&e[x][1]>(new Date).getTime())B((function(){b(A).then((function(){P===p&&2===m&&q(e[x][0],!1)}))}),K,null);else{var t=function(){clientPackages.get("serverRequests",{timeout:15}).then((function(e){e.send("-modal-window-open",{i:d,d:JSON.stringify(null!==F?{}:a),g:n?0:1},{timeout:T}).then((function(n){b(A).then((function(){if(P===p&&2===m){var e=JSON.parse(n),t=function(){null!==F?q(F,!1):void 0!==e.c?q(e.c,!0):K()};void 0!==e.g?B(t,K,e.g):t()}}))})).catch(K)})).catch(K)};B(t,t,null)}}))};if(null!==F)g(A).then((function(){B((function(){b(A).then((function(){q(F,!1)}))}),(function(){b(A).then((function(){J()}))}),null)}));else{if("d"===w&&void 0===e[x]&&"{}"===JSON.stringify(a)){var W=document.head.querySelector('[type="ipmw"][data-name="'+d+'"]');if(null!==W){var H=JSON.parse(W.getAttribute("data-content"));e[x]=[H,(new Date).getTime()+1e3*H.cacheTTL]}}J()}return!0},close:l,enable:c,disable:s}},A=function(n){var e={onOpen:function(n){n.querySelector('[data-modal-window-component="content-button-ok"]').addEventListener("click",T)}},t=!1;e.onFail=function(){t=!0,alert(n)},e.closeOnEscKey=!0;var o=O();return o.open("",{m:n},e,"m"),{close:function(n){return!t&&o.close(n)}}},E=function(n){return void 0===n&&(n=i),A(n)},k=function(n){return void 0===n&&(n=l),A(n)},L=function(n){void 0===n&&(n={});var e=void 0!==n.lastWindowID?n.lastWindowID:null;return new Promise((function(o,i){if(null!==t&&t.childNodes.length>0){var l=t.childNodes;if(null!==e){for(var r=!1,u=0;u<l.length;u++){var d=l[u];d.id===e?(h(d,!0),r=!0):r&&(d.getAttribute("class","ipmdlwndwv")?d.mwClose():t.removeChild(d))}if(r)return void o()}for(u=l.length-2;u>=0;u--)t.removeChild(l[u]);var c=t.firstChild;null!==c?(n.returnPromise=!0,c.mwClose(n).then(o)):o()}else P++,D().then(o).catch(i)}))},T=function(n){return void 0===n&&(n={}),new Promise((function(e,o){if(null!==t){var i=t.lastChild;if(null!==i)return n.returnPromise=!0,void i.mwClose(n).then(e)}e()}))},D=function(){return new Promise((function(n,e){var o=!0;null!==t&&t.lastChild&&(o=t.lastChild.mwCloseOnEscKey);b(o).then((function(){null!==t&&0!==t.childNodes.length||y(),n()})).catch(e)}))};return{initialize:function(n){return o=n[0],i=n[1],l=n[2],this},open:function(n,e,t){void 0===t&&(t={});var o=O();return o.open(n,e,t,"d"),{close:function(n){return o.close(n)},enable:function(){o.enable()},disable:function(){o.disable()}}},openMessage:A,openError:E,openOffline:k,closeAll:L,closeCurrent:T,showLoading:function(n){void 0===n&&(n={});var e=void 0===n.closeOnEscKey||n.closeOnEscKey;return new Promise((function(n,t){g(e).then(n).catch(t)}))},hideLoading:D,hasOpened:function(){return null!==f}}}();
EOT;
