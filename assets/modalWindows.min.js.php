<?php

/*
 * Modal windows addon for Bear Framework
 * https://github.com/ivopetkov/modal-windows-bearframework-addon
 * Copyright (c) Ivo Petkov
 * Free to use under the MIT license.
 */

return <<<'EOT'
var ivoPetkov=ivoPetkov||{};ivoPetkov.bearFrameworkAddons=ivoPetkov.bearFrameworkAddons||{},ivoPetkov.bearFrameworkAddons.modalWindows=ivoPetkov.bearFrameworkAddons.modalWindows||function(){var n=!1,e={},t=null,o="",i="",l="",r=0,u="mw-"+(new Date).getTime().toString()+"-";Promise=window.Promise||function(n){var e=[],t=null;this.then=function(n){return e.push(n),this},this.catch=function(n){return null===t&&(t=n),this};var o=function(){for(var n in e)e[n].apply(null,arguments)},i=function(){null!==t&&t.apply(null,arguments)};window.setTimeout((function(){n(o,i)}),16)};var d=null,c=!1,a=!1,s=!1,v=function(){if(c)return!1;if(a)return!1;if(s)return!1;var n=d.getData("ipmw");null!==n?"l"===n||(null!==document.getElementById(n)?T({lastWindowID:n}):-1===n.indexOf(u)&&T()):T()},f=function(n){d.open(null,null,null,{ipmw:n},!1)},m=null,w=null,h=0,p=function(n,e){e?(n.setAttribute("class","ipmdlwndwv"),n.removeAttribute("inert")):(n.setAttribute("class","ipmdlwndwvh"),n.setAttribute("inert","true"))},g=function(){if(null!==t&&t.lastChild){var n=t.lastChild;if(1===w)return O++,y(n.mwCloseOnEscKey).then((function(){p(n,!0)})),!1;if(null!==n.getAttribute("data-mw-disabled"))return!1;if(n.mwClose())return!1}else null!==w&&T()},b=function(n){return h++,new Promise((function(e,t){if(1!==w){w=1;var o=function(){clientPackages.get("lightbox",{timeout:15}).then((function(t){m=t.make({showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:g}),f("l"),e()}))};null===d?clientPackages.get("windowNavigation").then((function(n){(d=n).addChangeHandler(v),o()})):o()}else e()}))},y=function(n){return--h<0&&(h=0),h>0?new Promise((function(n,e){n()})):1===w?(w=2,new Promise((function(e,t){("l"!==d.getData("ipmw")?Promise.resolve():(c=!0,new Promise((function(n,e){d.goBack().then((function(){c=!1,n()}))})))).then((function(){m.open("",{showCloseButton:!1,spacing:0,closeOnEscKey:n,onBeforeEscKeyClose:g,resolveBeforeHTMLAdded:!0}).then(e).catch(t)}))}))):new Promise((function(n,e){n()}))},C=function(){null!==m&&(h=0,w=null,m.close(),m=null)},P=n=>{let e=document.createElement("div");return e.innerText=n,e.innerHTML},O=0,A=function(){var i=null,l=function(n){void 0===n&&(n={});var e=void 0!==n.returnPromise&&n.returnPromise,o=void 0!==n.expectOpen&&n.expectOpen,l=void 0!==n.expectShowLoading&&n.expectShowLoading;if(O++,null!==i&&null!==t){var r="ipmdlwndwv"===i.getAttribute("class"),u=null,c=i.previousSibling;return i.setAttribute("class","ipmdlwndwh"),r&&function(n){n.id===d.getData("ipmw")&&(a=!0,d.goBack().then((function(){a=!1})))}(i),window.setTimeout((function(){t.removeChild(i),i=null,0===t.childNodes.length&&(t.parentNode.removeChild(t),t=null),null!==c&&p(c,!0),(o||l)&&(null!==t&&0!==t.childNodes.length||C()),null!==u&&u(!0)}),300),o||l||t.childNodes.length-1==0&&C(),!e||new Promise((function(n,e){u=n}))}return!!e&&new Promise((function(n,e){n(!1)}))},c=function(){null!==i&&(i.removeAttribute("data-mw-disabled"),i.removeAttribute("inert"))},v=function(){null!==i&&(i.setAttribute("data-mw-disabled","1"),i.setAttribute("inert","true"))};return{open:function(d,a,m,h){if(void 0===a&&(a={}),void 0===m&&(m={}),null!==i)return!1;var g=++O,C=void 0!==m.onOpen?m.onOpen:null,A=void 0!==m.onFail?m.onFail:null,E=void 0===m.closeOnEscKey||m.closeOnEscKey,T=void 0!==m.showErrors&&m.showErrors,D=void 0!==m.timeout?m.timeout:30,N=void 0!==m.title?m.title:null;if(null!==t)for(var K=t.childNodes,B=0;B<K.length;B++)p(K[B],!1);var x=function(){if(S().then((function(){if(T){var n=window.navigator;void 0!==n.onLine&&n.onLine?k():L()}if(null!==A)try{A()}catch(n){}})),null!==t){var n=t.lastChild;null!==n&&p(n,!0)}},q=function(e,t,o){n?e():clientPackages.get("html5DOMDocument",{timeout:15}).then((function(i){if(null===o){var l=document.head.querySelector('[type="ipmwg"]');null!==l&&(o=l.getAttribute("data-content"))}null!==o?(i.insert(o),n=!0,e()):t()})).catch(x)},F=d+"$"+h+"$"+JSON.stringify(a),M=function(n,d){null===t&&((t=document.createElement("div")).setAttribute("class","ipmdlwndwsc"),document.body.appendChild(t)),(i=document.createElement("div")).setAttribute("id",(r++,u+r)),i.setAttribute("data-form-tooltip-container","true"),t.appendChild(i);var a="";a+='<div data-modal-window-component="header">',a+='<div data-modal-window-component="header-title"></div>',a+='<div data-modal-window-component="header-buttons">',void 0!==n.headerButtons&&(a+=n.headerButtons.join("")),a+='<div data-modal-window-component="header-button-close" tabindex="0" role="button" title="'+o+'"></div>',a+="</div>",a+="</div>",a+='<div data-modal-window-component="content"></div>',html5DOMDocument.insert('<div><div data-modal-window-component="window">'+a+"</div></div>",[i]);var m=i.firstChild.firstChild,w=m.querySelector('[data-modal-window-component="header-title"]'),h=m.querySelector('[data-modal-window-component="header-button-close"]'),g=m.querySelector('[data-modal-window-component="content"]');h.addEventListener("click",l),h.addEventListener("keydown",(function(n){13===n.keyCode&&l()})),void 0!==n.width&&(m.style.width=n.width);var b=null;null!==N?b=N:void 0!==n.title&&(b=n.title),null!==b&&(w.innerHTML=P(b).split("\n").join("<br>")),void 0!==n.content&&html5DOMDocument.insert(n.content,[g]);for(var y=m.querySelectorAll("form"),O=0;O<y.length;O++){var A=y[O];A.addEventListener("submitstart",v),A.addEventListener("submitend",c)}i.mwClose=l,i.mwCloseOnEscKey=E,d&&void 0!==n.cacheTTL&&(e[F]=[n,(new Date).getTime()+1e3*n.cacheTTL]),s=!0,function(n){f(n.id)}(i),window.setTimeout((function(){p(i,!0),s=!1}),16),null!==C&&C(i)},J=null;if("m"===h){var W='<div data-modal-window-component="content-message">'+P(a.m).split("\n").join("<br>")+'</div><div data-modal-window-component="content-button-ok">OK</div>';J={width:"400px",content:W}}var H=function(){b(E).then((function(){if(void 0!==e[F]&&e[F][1]>(new Date).getTime())q((function(){y(E).then((function(){O===g&&2===w&&M(e[F][0],!1)}))}),x,null);else{var t=function(){clientPackages.get("serverRequests",{timeout:15}).then((function(e){e.send("-modal-window-open",{i:d,d:JSON.stringify(null!==J?{}:a),g:n?0:1},{timeout:D}).then((function(n){y(E).then((function(){if(O===g&&2===w){var e=JSON.parse(n),t=function(){null!==J?M(J,!1):void 0!==e.c?M(e.c,!0):x()};void 0!==e.g?q(t,x,e.g):t()}}))})).catch(x)})).catch(x)};q(t,t,null)}}))};if(null!==J)b(E).then((function(){q((function(){y(E).then((function(){M(J,!1)}))}),(function(){y(E).then((function(){H()}))}),null)}));else{if("d"===h&&void 0===e[F]&&"{}"===JSON.stringify(a)){var I=document.head.querySelector('[type="ipmw"][data-name="'+d+'"]');if(null!==I){var j=JSON.parse(I.getAttribute("data-content"));e[F]=[j,(new Date).getTime()+1e3*j.cacheTTL]}}H()}return!0},close:l,enable:c,disable:v}},E=function(n){var e={onOpen:function(n){n.querySelector('[data-modal-window-component="content-button-ok"]').addEventListener("click",D)}},t=!1;e.onFail=function(){t=!0,alert(n)},e.closeOnEscKey=!0;var o=A();return o.open("",{m:n},e,"m"),{close:function(n){return!t&&o.close(n)}}},k=function(n){return void 0===n&&(n=i),E(n)},L=function(n){return void 0===n&&(n=l),E(n)},T=function(n){void 0===n&&(n={});var e=void 0!==n.lastWindowID?n.lastWindowID:null;return new Promise((function(o,i){if(null!==t&&t.childNodes.length>0){var l=t.childNodes;if(null!==e){for(var r=!1,u=0;u<l.length;u++){var d=l[u];d.id===e?(p(d,!0),r=!0):r&&(d.getAttribute("class","ipmdlwndwv")?d.mwClose():t.removeChild(d))}if(r)return void o()}for(u=l.length-2;u>=0;u--)t.removeChild(l[u]);var c=t.firstChild;null!==c?(n.returnPromise=!0,c.mwClose(n).then(o)):o()}else O++,S().then(o).catch(i)}))},D=function(n){return void 0===n&&(n={}),new Promise((function(e,o){if(null!==t){var i=t.lastChild;if(null!==i)return n.returnPromise=!0,void i.mwClose(n).then(e)}e()}))},S=function(){return new Promise((function(n,e){var o=!0;null!==t&&t.lastChild&&(o=t.lastChild.mwCloseOnEscKey);y(o).then((function(){null!==t&&0!==t.childNodes.length||C(),n()})).catch(e)}))};return{initialize:function(n){return o=n[0],i=n[1],l=n[2],this},open:function(n,e,t){void 0===t&&(t={});var o=A();return o.open(n,e,t,"d"),{close:function(n){return o.close(n)},enable:function(){o.enable()},disable:function(){o.disable()}}},openMessage:E,openError:k,openOffline:L,closeAll:T,closeCurrent:D,showLoading:function(n){void 0===n&&(n={});var e=void 0===n.closeOnEscKey||n.closeOnEscKey;return new Promise((function(n,t){b(e).then(n).catch(t)}))},hideLoading:S,hasOpened:function(){return null!==m}}}();
EOT;
